<!DOCTYPE html>
<html lang="tr">
<head>
    <script>
        const userRole = localStorage.getItem('userRole');
        if (!userRole) { window.location.href = 'login.html'; }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pia YÃ¶netim | Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; letter-spacing: -0.01em; }
        
        .sidebar-link { 
            color: #64748b; 
            transition: all 0.2s ease; 
            border-radius: 12px;
            margin: 4px 0;
        }
        .sidebar-link:hover { 
            background: #f1f5f9; 
            color: #4f46e5;
            transform: translateX(4px);
        }
        .active-link { 
            background: #eef2ff !important; 
            color: #4f46e5 !important;
            font-weight: 700;
            border-right: 4px solid #4f46e5;
            border-radius: 0 12px 12px 0;
        }
        
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="bg-[#f8fafc] text-slate-900 overflow-hidden">

    <div class="flex h-screen">
        <aside class="w-72 bg-white border-r border-slate-200 flex flex-col shrink-0 shadow-sm">
            <div class="p-6 mb-4">
                <div class="bg-slate-50 border border-slate-100 p-4 rounded-3xl flex items-center justify-between gap-3 shadow-sm">
                    <div class="flex flex-col">
                        <h1 class="text-lg font-black tracking-tighter italic leading-none text-slate-800">PIA</h1>
                        <span class="text-orange-500 font-black italic text-sm tracking-tighter">YÃ–NETÄ°M</span>
                        <p class="text-[8px] text-slate-400 font-bold uppercase tracking-widest mt-1">Admin</p>
                    </div>
                    
                </div>
            </div>

            <nav class="flex-grow px-4 space-y-1">
                <a href="anasayfa.html" class="flex items-center gap-3 py-3 px-4 active-link text-sm transition-all">
                    <i class="fas fa-th-large w-5 text-lg"></i> Genel BakÄ±ÅŸ
                </a>
                <a href="site_tanimlar.html" class="sidebar-link flex items-center gap-3 py-3 px-4 text-sm font-semibold transition-all">
                    <i class="fas fa-building-circle-check w-5 text-lg opacity-70"></i> Site & Bloklar
                </a>
                <a href="finans.html" class="sidebar-link flex items-center gap-3 py-3 px-4 text-sm font-semibold transition-all">
                    <i class="fas fa-wallet w-5 text-lg opacity-70"></i> Finans YÃ¶netimi
                </a>
            </nav>

            <div class="p-6 border-t border-slate-100 bg-slate-50/50">
                <button onclick="logout()" class="w-full flex items-center justify-center gap-3 py-3 px-4 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-2xl font-bold transition-all text-xs uppercase tracking-widest">
                    <i class="fas fa-power-off"></i> GÃ¼venli Ã‡Ä±kÄ±ÅŸ
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="h-20 bg-white border-b border-slate-200 flex items-center justify-between px-8 shrink-0 z-10">
                <div class="flex items-center gap-6">
                    <h2 class="text-xl font-extrabold text-slate-800 tracking-tight">Panel Ã–zeti</h2>
                    <button onclick="duyuruModalAc()" class="bg-orange-500 hover:bg-orange-600 text-white px-5 py-2 rounded-xl text-[10px] font-black transition-all shadow-md shadow-orange-500/20 uppercase tracking-widest flex items-center gap-2">
                        <i class="fas fa-plus"></i> Duyuru YayÄ±nla
                    </button>
                </div>
                
                <div class="flex items-center gap-4 border-l border-slate-100 pl-6">
                    <div class="text-right hidden sm:block">
                        <p class="text-sm font-black text-slate-700 leading-none" id="adminName">YÃ¶netici</p>
                        <span class="text-[9px] text-indigo-600 font-extrabold uppercase tracking-widest mt-1 inline-block">Sistem Yetkilisi</span>
                    </div>
                    <img id="adminAvatar" src="" class="w-10 h-10 rounded-xl shadow-sm border border-slate-200">
                </div>
            </header>

            <div class="p-8 overflow-y-auto space-y-8 bg-[#f8fafc]">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm flex items-center gap-5 hover:shadow-md transition-shadow">
                        <div class="w-14 h-14 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center text-2xl"><i class="fas fa-door-open"></i></div>
                        <div><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-0.5">KayÄ±tlÄ± Daireler</p><h3 id="stat-active-apartments" class="text-2xl font-black text-slate-800 tracking-tighter">...</h3></div>
                    </div>
                    <div class="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm flex items-center gap-5 hover:shadow-md transition-shadow">
                        <div class="w-14 h-14 bg-orange-50 text-orange-600 rounded-2xl flex items-center justify-center text-2xl"><i class="fas fa-screwdriver-wrench"></i></div>
                        <div><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-0.5">Bekleyen Talepler</p><h3 id="stat-pending" class="text-2xl font-black text-slate-800 tracking-tighter">0</h3></div>
                    </div>
                    <div class="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm flex items-center gap-5 hover:shadow-md transition-shadow">
                        <div class="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center text-2xl"><i class="fas fa-bullhorn"></i></div>
                        <div><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-0.5">Duyurular</p><h3 id="stat-announcements" class="text-2xl font-black text-slate-800 tracking-tighter">0</h3></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white rounded-[2.5rem] border border-slate-200 shadow-sm overflow-hidden flex flex-col h-[550px]">
                        <div class="p-6 border-b border-slate-50 bg-slate-50/50 flex justify-between items-center">
                            <h3 class="font-black text-slate-800 flex items-center gap-2"><i class="fas fa-bullhorn text-orange-500"></i> Aktif Duyurular</h3>
                        </div>
                        <div id="dashboardDuyuruListesi" class="p-6 space-y-4 overflow-y-auto flex-grow"></div>
                    </div>

                    <div class="bg-white rounded-[2.5rem] border border-slate-200 shadow-sm overflow-hidden flex flex-col h-[550px]">
                        <div class="p-6 border-b border-slate-50 bg-slate-50/50 flex justify-between items-center">
                            <h3 class="font-black text-slate-800 flex items-center gap-2"><i class="fas fa-clipboard-list text-indigo-500"></i> GÃ¼ncel Talepler</h3>
                        </div>
                        <div class="overflow-auto flex-grow">
                            <table class="w-full text-left">
                                <thead class="sticky top-0 bg-white border-b border-slate-100 text-[10px] font-black text-slate-400 uppercase tracking-widest z-10">
                                    <tr>
                                        <th class="px-6 py-4">Sakin</th>
                                        <th class="px-6 py-4">Konu</th>
                                        <th class="px-6 py-4 text-center">Durum</th>
                                        <th class="px-6 py-4 text-right">Ä°ÅŸlem</th>
                                    </tr>
                                </thead>
                                <tbody id="adminTalepListesi" class="divide-y divide-slate-50 text-sm"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="duyuruModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-lg overflow-hidden border border-white/20">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-orange-50/30">
                <h3 class="text-xl font-black text-slate-800">Yeni Duyuru</h3>
                <button onclick="duyuruModalKapat()" class="w-8 h-8 flex items-center justify-center rounded-full bg-white shadow-sm text-slate-400 hover:text-red-500 transition-all"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="text" id="duyuruBaslik" placeholder="BaÅŸlÄ±k" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-orange-500 transition-all">
                <select id="duyuruOncelik" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-orange-500 transition-all font-bold text-slate-600 text-sm">
                    <option value="Normal">Normal Ã–ncelik</option>
                    <option value="DÃ¼ÅŸÃ¼k">DÃ¼ÅŸÃ¼k Ã–ncelik</option>
                    <option value="Acil">Acil Durum ðŸš¨</option>
                </select>
                <textarea id="duyuruIcerik" rows="4" placeholder="MesajÄ±nÄ±z..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-orange-500 transition-all resize-none"></textarea>
                <button onclick="duyuruYayinla()" class="w-full py-4 bg-orange-500 text-white font-black rounded-xl shadow-lg shadow-orange-500/30 hover:bg-orange-600 transition-all uppercase tracking-widest text-sm">PaylaÅŸ</button>
            </div>
        </div>
    </div>

    <div id="talepCozumModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-indigo-50/30">
                <h3 class="text-xl font-black text-slate-800">Talebi YanÄ±tla</h3>
                <button onclick="modalKapat()" class="w-8 h-8 flex items-center justify-center rounded-full bg-white shadow-sm text-slate-400 hover:text-red-500 transition-all"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-xs text-indigo-900 font-medium italic" id="modalSakinMesaj"></div>
                <input type="hidden" id="selectedTalepId">
                <textarea id="cozumAciklama" rows="4" class="w-full p-3 border border-slate-200 rounded-xl outline-none focus:border-indigo-500 transition-all text-sm" placeholder="YÃ¶netici notunuz..."></textarea>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="talepGuncelle('Reddedildi')" class="py-4 bg-red-50 text-red-600 font-black rounded-xl hover:bg-red-100 transition-all uppercase text-[10px]">Reddet</button>
                    <button onclick="talepGuncelle('TamamlandÄ±')" class="py-4 bg-indigo-600 text-white font-black rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-500/30 transition-all uppercase text-[10px]">Tamamla</button>
                </div>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-xs overflow-hidden transform transition-all border border-slate-100">
            <div class="p-8 text-center">
                <div class="w-16 h-16 bg-red-50 text-red-500 rounded-2xl flex items-center justify-center text-2xl mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3 class="text-lg font-black text-slate-800 mb-2">Emin misiniz?</h3>
                <p class="text-[11px] text-slate-500 font-medium leading-relaxed" id="confirmMessage">Bu iÅŸlem geri alÄ±namaz.</p>
            </div>
            <div class="flex border-t border-slate-50">
                <button id="confirmCancel" class="flex-1 py-4 text-[10px] font-bold text-slate-400 hover:bg-slate-50 transition-all border-r border-slate-50 uppercase tracking-widest">Ä°ptal</button>
                <button id="confirmApprove" class="flex-1 py-4 text-[10px] font-black text-red-500 hover:bg-red-50 transition-all uppercase tracking-widest">Evet, Sil</button>
            </div>
        </div>
    </div>

    <script>
        // MODAL KONTROLLERÄ°
        function duyuruModalAc() { document.getElementById('duyuruModal').classList.remove('hidden'); }
        function duyuruModalKapat() { document.getElementById('duyuruModal').classList.add('hidden'); }
        function modalKapat() { document.getElementById('talepCozumModal').classList.add('hidden'); }
        function logout() { localStorage.clear(); window.location.href = 'login.html'; }

        // YENÄ°: MODERN ONAY KUTUSU MANTIÄžI
        function modernConfirm(mesaj, callback) {
            const modal = document.getElementById('confirmModal');
            const msgElem = document.getElementById('confirmMessage');
            const btnApprove = document.getElementById('confirmApprove');
            const btnCancel = document.getElementById('confirmCancel');

            msgElem.innerText = mesaj;
            modal.classList.remove('hidden');

            btnApprove.onclick = () => {
                modal.classList.add('hidden');
                callback();
            };

            btnCancel.onclick = () => {
                modal.classList.add('hidden');
            };
        }

        async function loadDashboard() {
            const username = localStorage.getItem('username') || 'YÃ¶netici';
            document.getElementById('adminName').innerText = username;
            document.getElementById('adminAvatar').src = `https://ui-avatars.com/api/?name=${username}&background=4338ca&color=fff&bold=true&rounded=true`;
            await updateAllData();
        }

        async function updateAllData() {
            try {
                const [statsRes, duyuruRes, talepRes] = await Promise.all([
                    fetch('/api/admin/stats').then(r => r.json()),
                    fetch('/api/duyurular').then(r => r.json()),
                    fetch('/api/admin/talepler').then(r => r.json())
                ]);
                document.getElementById('stat-active-apartments').innerText = statsRes.activeApartments || 0;
                document.getElementById('stat-pending').innerText = statsRes.pendingRequests || 0;
                document.getElementById('stat-announcements').innerText = duyuruRes.length;
                renderDuyurular(duyuruRes);
                renderTalepler(talepRes);
            } catch (err) { console.error("Veri HatasÄ±:", err); }
        }

        function renderDuyurular(data) {
            const container = document.getElementById('dashboardDuyuruListesi');
            container.innerHTML = data.map(d => `
                <div class="p-5 bg-slate-50/50 border border-slate-100 rounded-3xl relative group hover:bg-white hover:shadow-md transition-all">
                    <div class="flex justify-between items-start mb-2">
                        <span class="px-2 py-0.5 bg-orange-100 text-orange-600 text-[9px] font-black rounded-md uppercase">${d.oncelik}</span>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] font-bold text-slate-400">${new Date(d.tarih).toLocaleDateString('tr-TR')}</span>
                            <button onclick="duyuruSil(${d.id})" class="text-slate-300 hover:text-red-500 transition-all"><i class="fas fa-trash-alt text-xs"></i></button>
                        </div>
                    </div>
                    <h4 class="font-bold text-slate-800 text-sm mb-1">${d.baslik}</h4>
                    <p class="text-xs text-slate-500 leading-relaxed line-clamp-2">${d.icerik}</p>
                </div>
            `).join('') || '<p class="text-center text-slate-400 py-10 italic text-sm">HenÃ¼z bir duyuru yok.</p>';
        }

        function renderTalepler(data) {
            const body = document.getElementById('adminTalepListesi');
            body.innerHTML = data.map(t => `
                <tr class="hover:bg-slate-50 transition-all">
                    <td class="px-6 py-4">
                        <div class="font-bold text-slate-800 text-xs">${t.sakin_ad_soyad}</div>
                        <div class="text-[9px] text-indigo-500 font-bold uppercase">Daire: ${t.daire_no}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-semibold text-slate-700 text-[11px] truncate max-w-[150px]">${t.konu}</div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="px-2 py-0.5 rounded-md text-[8px] font-black uppercase ${t.durum === 'Bekliyor' ? 'bg-orange-100 text-orange-600' : 'bg-emerald-100 text-emerald-600'}">${t.durum}</span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex justify-end gap-2">
                            <button onclick="talepCozumAc('${t.id}', '${t.aciklama.replace(/'/g, "\\'")}')" class="w-8 h-8 bg-emerald-50 text-emerald-600 rounded-lg hover:bg-emerald-600 hover:text-white transition-all flex items-center justify-center shadow-sm">
                                <i class="fas fa-check text-[10px]"></i>
                            </button>
                            <button onclick="talepSil('${t.id}')" class="w-8 h-8 bg-red-50 text-red-500 rounded-lg hover:bg-red-500 hover:text-white transition-all flex items-center justify-center shadow-sm">
                                <i class="fas fa-trash-alt text-[10px]"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="4" class="p-10 text-center text-slate-400 text-xs italic">Talep bulunamadÄ±.</td></tr>';
        }

        async function duyuruYayinla() {
            const baslik = document.getElementById('duyuruBaslik').value;
            const icerik = document.getElementById('duyuruIcerik').value;
            const oncelik = document.getElementById('duyuruOncelik').value;
            if(!baslik || !icerik) return alert("LÃ¼tfen tÃ¼m alanlarÄ± doldurun!");
            await fetch('/api/duyurular', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ baslik, icerik, oncelik })
            });
            duyuruModalKapat();
            updateAllData();
        }

        // GÃœNCELLENDÄ°: DUYURU SÄ°LME ONAYI
        async function duyuruSil(id) {
            modernConfirm("Bu duyuruyu kaldÄ±rmak istediÄŸinize emin misiniz?", async () => {
                await fetch(`/api/duyurular/${id}`, { method: 'DELETE' });
                updateAllData();
            });
        }

        async function talepGuncelle(durum) {
            const id = document.getElementById('selectedTalepId').value;
            const not = document.getElementById('cozumAciklama').value;
            await fetch(`/api/admin/talepler/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ durum, yonetici_notu: not })
            });
            modalKapat();
            updateAllData();
        }

        function talepCozumAc(id, mesaj) {
            document.getElementById('selectedTalepId').value = id;
            document.getElementById('modalSakinMesaj').innerText = mesaj;
            document.getElementById('talepCozumModal').classList.remove('hidden');
        }

        // GÃœNCELLENDÄ°: TALEP SÄ°LME ONAYI
        async function talepSil(id) {
            modernConfirm("Talebi kalÄ±cÄ± olarak silmek istediÄŸinize emin misiniz?", async () => {
                await fetch(`/api/admin/talepler/${id}`, { method: 'DELETE' });
                updateAllData();
            });
        }

        window.onload = loadDashboard;
    </script>
</body>
</html>